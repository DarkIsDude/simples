




<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>Ajouter une vente</title>

    <link type="text/css" rel="stylesheet" media="screen" href="static/css/new_main.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="static/css/flag.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="static/css/loading_overlay.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="static/css/jquery.jqplot-1.0.4.min.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="static/css/ui-lightness/jquery-ui-1.11.1.css" />

    <script language="javascript" type="text/javascript" src="static/js/jquery-1.10.2.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jquery-ui-1.11.1.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jquery-migrate-1.2.1.min.js "></script>

    <!--[if IE]><script language="javascript" type="text/javascript" src="static/js/excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="static/js/jquery.jqplot-1.0.4.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jqplot_plugins/jqplot.dateAxisRenderer.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jqplot_plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jqplot_plugins/jqplot.barRenderer.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jqplot_plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/jqplot_plugins/jqplot.categoryAxisRenderer.min.js"></script>
    <script language="javascript" type="text/javascript" src="static/js/loading-overlay.min.js"></script>



    <!--[if IE 6]><link rel="stylesheet" media="screen" href="static/css/IE6.css" /><![endif]-->

    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="-1">
    <script type="text/javascript" src="static/js/jquery.form.js"></script>
    <script type="text/javascript" src="static/js/jquery.ui.autocomplete.html.js"></script>
    <script type="text/javascript" src="static/js/jquery.ui.datepicker-fr.js"></script>

    <script type="text/javascript" src="static/js/fileupload/jquery.iframe-transport.js"></script>
    <script type="text/javascript" src="static/js/fileupload/jquery.fileupload.js"></script>
    <link type="text/css" rel="stylesheet" media="screen" href="static/css/add_sale.css" />
    <script>
    $(function () {
        $( ".tabs" ).tabs();
    });
    </script>


    <script type="text/javascript">
        $(document).ajaxSend(function(event, xhr, settings) {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            function sameOrigin(url) {
                // url could be relative or scheme relative or absolute
                var host = document.location.host; // host + port
                var protocol = document.location.protocol;
                var sr_origin = '//' + host;
                var origin = protocol + sr_origin;
                // Allow absolute or scheme relative URLs to same origin
                return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));
            }
            function safeMethod(method) {
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        });
        $(document).ready(function(){
        	$("#language").change(function(event){
        		$("#language_next").val(window.location.pathname);
        		$("#language_form").submit()
        	});
        });
    </script>

    <!--<script type="text/javascript" src="dist/bundle.js"></script>-->
    <link type="text/css" rel="stylesheet" media="screen" href="dist/style.css" />
    <!--[if IE]><style> select { background: none !important; }</style><![endif]-->
</head>
<body>

	<!--HEADER-->
	<div id="header">

		<div id="wrapHead">
			<h1><a href="/"></a></h1>
			<!--NAV-->
			<div id="nav">

				<form id="language_form" method="POST" action="/setlang/">
                    <input type='hidden' name='csrfmiddlewaretoken' value='uthIeaJNPFphVpnXYzcP2VoA6EPTdhPH' />
                    <input id="language_next" name="next" type="hidden" value="/" />
                    <select id="language" name="language">

                            <option value="en-us"
                                    class="pays us"
                                    >
                                Anglais
                            </option>

                            <option value="fr-FR"
                                    class="pays fr"

                                        selected
                                    >
                                Français
                            </option>

                            <option value="zh-CN"
                                    class="pays cn"
                                    >
                                Chinois
                            </option>

                    </select>
				</form>

				<div id="home_ico">
					<a href="/">home page</a>
				</div>

                <div id="brand_ico">
                    <img src="http://23.95.71.16:80/img/brand_logos/dragon-dollar.png" />
                </div>

				<ul id="menu_ico">
					<li><a class="link1" href="/sales/new/">Ajouter une vente</a></li>
					<li><a class="link2" href="/sales/list/current/">Ventes en cours</a></li>
					<li><a class="link3" href="/sales/list/old/">Historique des ventes</a></li>
					<li><a class="link4" href="/shops/">Boutiques</a></li>
					<li><a class="link5" href="_quick_nav.html#">Les stats de ma marque</a></li>
					<li><a class="link6" href="_quick_nav.html#">Carte de France des performances</a></li>
					<li><a class="link7" href="/accounts/operators/">Operators mgmt</a></li>
				</ul>
			</div>
			<!--FIN NAV-->

			<div id="welcome">
				You are logged in as <span id="userName">军 王 (administrator)</span>
			</div>

			<a id="logout" href="/logout?next=/">Logout</a>
		</div>
	</div>
	<!--FIN HEADER-->

    <!--ALERTE-->
	<div id="alerte" class="hidden">
		<p class="info">Une mise a jour est disponible</p>
		<p class="warning">Stock bas pour la chemise megeve</p>
		<p class="stop">Plus de stock pour la chemise lalou</p>
	</div>
	<!--FIN ALERTE-->



	<!--CONTENEUR-->
	<div id="conteneur">
		<!--CONTENU-->
		<div id="contenu">

    <!--Lien Haut de Page -->
    <a id="lienUP" href="#conteneur">Haut de Page</a>

    <!--Title-->
    <div id="title">
        <span>Ajouter une vente</span>
        <h2>
            Ajouter une vente
        </h2>
    </div>

    <form id="main_form" action="/sales/new/" enctype="multipart/form-data" method="post"><input type='hidden' name='csrfmiddlewaretoken' value='uthIeaJNPFphVpnXYzcP2VoA6EPTdhPH' />
        <ul class="arianne">
            <li class="li1 "><a href="#"><span>Boutiques</span>1</a></li>
            <li class="li2 on"><span>Produits</span>2</li>
            <li class="li3 "><span>Shipping</span>3</li>
        </ul>


    <input id="id_sale_wizard_new-current_step" name="sale_wizard_new-current_step" type="hidden" value="product" />
    <input id="id_product-shop_ids" name="product-shop_ids" type="hidden" value="[]" />
    <fieldset>
        <div class="p_vide formrow">

        </div>

        <div class="colLeft bkcolor">
            <h3 class="sstitle">Product information</h3>


            <div class="formrow">
                <label for="id_product-name">Nom du produit</label>
                <input id="id_product-name" maxlength="50" name="product-name" type="text" /><input id="initial-product-id_product-name" name="initial-product-name" type="hidden" />
            </div>


            <div class="marge formrow">
                <label for="id_product-brand">Marque</label>
                <select id="id_product-brand" name="product-brand">
<option value="" selected="selected">---------</option>
<option value="1">brand1test</option>
</select> ou  <a href="#" id="add_new_brand">Ajouter une marque</a>
                <span id="brand_new_error" style="display:none"></span>
            </div>


            <div class="formrow">
                <label for="id_product-category">Catégorie de produit</label>
                <select id="id_product-category" name="product-category" onChange="getTypeOptions(this.value)">
<option value="" selected="selected">---------</option>
<option value="1">Chinese coins</option>
</select>

                    <span class="helptext">Uncategorized item</span>

            </div>


            <div class="formrow">
                <label for="id_product-type">Type</label>
                <input id="id_product-type" name="product-type" type="hidden" />
                <select id="product_type_selector" name="product_type_selector" onchange="getItemTypeAttributeOptions(this.value)"></select>
            </div>


            <div class="marge formrow">
                <label for=id_product-gender>Genre ciblé</label>
                <select id="id_product-gender" name="product-gender">
<option value="U">Non applicable</option>
<option value="M">Homme</option>
<option value="F">Femme</option>
</select>
            </div>


            <div class="formrow small">
                <label for="id_product-weight_unit">Weight Unit</label>
                <span><select id="id_product-weight_unit" name="product-weight_unit">
<option value="">---------</option>
<option value="kg" selected="selected">kg</option>
<option value="g">g</option>
<option value="lb">lb</option>
<option value="oz">oz</option>
</select></span>
            </div>


            <div class="marge formrow">
                <input id="id_type_attribute_weights-TOTAL_FORMS" name="type_attribute_weights-TOTAL_FORMS" type="hidden" value="0" /><input id="id_type_attribute_weights-INITIAL_FORMS" name="type_attribute_weights-INITIAL_FORMS" type="hidden" value="0" /><input id="id_type_attribute_weights-MAX_NUM_FORMS" name="type_attribute_weights-MAX_NUM_FORMS" type="hidden" value="1000" />
                <label>Weight</label>
                <span class="contForm" id="type_attribute_weights">
                    <div id="add_taw_form">
                        <select id="type_attribute_weight_selector" name="type_attribute_weight_selector">
                            <option value="0">Standard Weight</option>
                        </select>
                        <span class="raw">></span>
                        <input id="type_attribute_weight_input" class="inputXS" type="text" name="type_attribute_weight_input"/>
                        <span id="taw_weight_unit">kg</span>
                        <a id="add_taw" href="#">Ajouter</a>
                    </div>

                    <input id="id_product-standard_weight" name="product-standard_weight" type="hidden" />


                </span>
            </div>


            <div class="formrow">
                <label for="id_product-currency">Currency</label>
                <span><select disabled="disabled" id="id_product-currency" name="product-currency">
<option value="">---------</option>
<option value="1" selected="selected">EUR</option>
<option value="2">USD</option>
<option value="3">CNY</option>
</select></span>
                <input type="hidden" name="product-currency" value="1" />
            </div>

            <input class="inputXS" id="id_product-preview_base_price" name="product-preview_base_price" style="display: none;" type="text" />

            <div class="marge formrow">
                <input id="id_type_attribute_prices-TOTAL_FORMS" name="type_attribute_prices-TOTAL_FORMS" type="hidden" value="0" /><input id="id_type_attribute_prices-INITIAL_FORMS" name="type_attribute_prices-INITIAL_FORMS" type="hidden" value="0" /><input id="id_type_attribute_prices-MAX_NUM_FORMS" name="type_attribute_prices-MAX_NUM_FORMS" type="hidden" value="1000" />
                <label>Prix </label>
                <span class="contForm" id="type_attribute_prices">
                    <div id="add_tap_form">
                        <select id="type_attribute_selector" name="type_attribute_selector">
                            <option value="0">Unified price</option>
                        </select>
                        <span class="raw">></span>
                        <input id="type_attribute_price_input" class="inputXS" type="text" name="type_attribute_price_input"/>
                        <span id="tap_currency">EUR</span>
                        <a id="add_tap" href="#">Ajouter</a>
                    </div>

                <input id="id_product-normal_price" name="product-normal_price" type="hidden" />


                </span>
            </div>



            <div class="formrow">
                <label for="prixBTS">Discount </label>
                <span class="contForm" id="newPrice">
                    <input id="id_product-coupon_id" name="product-coupon_id" style="display: none;" type="text" />
                    <select id="id_product-discount_type" name="product-discount_type">
<option value="percentage">Percentage</option>
</select>
                    <input class="inputXS" id="id_product-preview_discount_price_str" name="product-preview_discount_price_str" style="display: none;" type="text" />
                    <span class="raw">></span><input class="inputXS" id="id_product-discount" name="product-discount" type="text" /><span id="discount_marker" class="discount_marker">%</span>
                    <span id="result">Prix après réduction : <strong id="discount_price">N/D</strong> <strong id="id_discount_price_marker">&nbsp;</strong></span>
                </span>
            </div>


            <div class="marge formrow">
                <label>Date de validité</label>
                <span>Du</span><input class="inputS" id="id_product-valid_from" name="product-valid_from" type="text" />
                <span>Au</span><input class="inputS" id="id_product-valid_to" name="product-valid_to" type="text" />
            </div>



            <div class="formrow">
                <label>Available</label>
                <span>Du</span><input class="inputS" id="id_product-available_from" name="product-available_from" type="text" />
                <span>Au</span><input class="inputS" id="id_product-available_to" name="product-available_to" type="text" />
            </div>

            <input id="id_barcodes-TOTAL_FORMS" name="barcodes-TOTAL_FORMS" type="hidden" value="1" /><input id="id_barcodes-INITIAL_FORMS" name="barcodes-INITIAL_FORMS" type="hidden" value="1" /><input id="id_barcodes-MAX_NUM_FORMS" name="barcodes-MAX_NUM_FORMS" type="hidden" value="1000" />

            <input id="id_externalrefs-TOTAL_FORMS" name="externalrefs-TOTAL_FORMS" type="hidden" value="1" /><input id="id_externalrefs-INITIAL_FORMS" name="externalrefs-INITIAL_FORMS" type="hidden" value="1" /><input id="id_externalrefs-MAX_NUM_FORMS" name="externalrefs-MAX_NUM_FORMS" type="hidden" value="1000" />

            <input id="id_ordersettings-TOTAL_FORMS" name="ordersettings-TOTAL_FORMS" type="hidden" value="1" /><input id="id_ordersettings-INITIAL_FORMS" name="ordersettings-INITIAL_FORMS" type="hidden" value="1" /><input id="id_ordersettings-MAX_NUM_FORMS" name="ordersettings-MAX_NUM_FORMS" type="hidden" value="1000" />


        </div>

        <div class="colRight bkcolor">
            <h3 class="sstitle">Product description</h3>


            <div class="marge formrow">
                <label for="id_product-cover_url">Cover picture</label>
                <span id="upload-coverfile">
                    <a class="uploadfile">

                        <div>Click or drag a file here to upload the picture</div>
                        <img class="cover_btn" style="display:none"/>

                    </a>
                    <input class="cover_upload" style="display:none" type="file" name="files[]">
                    <input id="id_product-cover_url" name="product-cover_url" type="hidden" />
                    <input id="id_product-cover_pk" name="product-cover_pk" type="hidden" />
                </span>
            </div>


            <div class="formrow">
                <label for="id_product-short_description">Short Description</label>
                <input id="id_product-short_description" maxlength="240" name="product-short_description" type="text" />
            </div>


            <div class="marge formrow">
                <label for="id_product-description">Full description</label>
                <textarea cols="40" id="id_product-description" name="product-description" rows="10">
</textarea>
            </div>

            <div id="varattrs">
            <input id="id_varattrs-TOTAL_FORMS" name="varattrs-TOTAL_FORMS" type="hidden" value="0" /><input id="id_varattrs-INITIAL_FORMS" name="varattrs-INITIAL_FORMS" type="hidden" value="0" /><input id="id_varattrs-MAX_NUM_FORMS" name="varattrs-MAX_NUM_FORMS" type="hidden" value="1000" />

            </div>
        </div>

        <div class="clear"></div>

        <!--VISUELS PRODUITS-->
        <div id="blocProd" class="tabs">
            <ul class="tabs-header">
                <li class="base-item">
                    <a href="#base-item">Nom du produit</a>
                </li>

                <li class="add-attr">
                    <a href="#brand-attr-0">Add a product variant</a>
                </li>
                <li class="gallery">
                    <a href="#gallery">Pictures Gallery</a>
                </li>
            </ul>






<div id="base-item" class="visuelProd">
    <ul style="display:none;" class="ba_error errorlist"></ul>
    <strong class="title">None</strong>
    <em>Please add pictures for this item below. Drag and drop pictures to arrange them in the desired order.</em>
    <input id="id_product_pictures-TOTAL_FORMS" name="product_pictures-TOTAL_FORMS" type="hidden" value="0" /><input id="id_product_pictures-INITIAL_FORMS" name="product_pictures-INITIAL_FORMS" type="hidden" value="0" /><input id="id_product_pictures-MAX_NUM_FORMS" name="product_pictures-MAX_NUM_FORMS" type="hidden" value="1000" />
    <div class="product_pictures listProd">
        <ul id="existing_pp" class="horizontal_pp">

            <li class="product_pictures_upload">
                <a class="uploadfile">Click or drag a file here to add a picture</a>
                <input id="pp_upload" style="display:none" type="file" name="files[]" multiple>
            </li>
        </ul>
        <ul class="pp_queue"></ul>
    </div>


    <div class="formrow marge accordion">
        <label>Code barre</label>
        <span class="contForm taille barcodes-block">


        <span class="barcodes-ba" data-ba="">




    <span class="barcodes-item" data-ca="">



                <label for="id_barcodes-0-upc"></label>
<input id="id_barcodes-0-upc" type="text"  name="barcodes-0-upc" maxlength="50" value="">
<span style="display: none;">
    <input id="id_barcodes-0-common_attribute" name="barcodes-0-common_attribute" type="text" />
    <input id="id_barcodes-0-brand_attribute" name="barcodes-0-brand_attribute" type="text" value="" />
    <input type="checkbox" name="barcodes-0-DELETE" id="id_barcodes-0-DELETE">
</span>




    </span>



        </span>


</span>

    </div>
    <div class="formrow marge accordion">
        <label>External Refs</label>
        <span class="contForm taille extrefs-block">


        <span class="extrefs-ba" data-ba="">




    <span class="extrefs-item" data-ca="">



                <label for="id_externalrefs-0-external_id"></label>
<input id="id_externalrefs-0-external_id" type="text"  name="externalrefs-0-external_id" maxlength="50" value="">
<span style="display: none;">
    <input id="id_externalrefs-0-common_attribute" name="externalrefs-0-common_attribute" type="text" />
    <input id="id_externalrefs-0-brand_attribute" name="externalrefs-0-brand_attribute" type="text" value="" />
    <input type="checkbox" name="externalrefs-0-DELETE" id="id_externalrefs-0-DELETE">
</span>




    </span>



        </span>


</span>

    </div>
    <div class="formrow marge accordion">
        <label>Order Require Confirmation</label>
        <span class="contForm taille ordersettings-block">


        <span class="ordersettings-ba" data-ba="">




    <span class="ordersettings-item" data-ca="">



                <label for="id_ordersettings-0-require_confirm"></label>
<input id="id_ordersettings-0-require_confirm" name="ordersettings-0-require_confirm" type="checkbox" />
<span style="display: none;">
    <input id="id_ordersettings-0-common_attribute" name="ordersettings-0-common_attribute" type="text" />
    <input id="id_ordersettings-0-brand_attribute" name="ordersettings-0-brand_attribute" type="text" value="" />
    <input type="checkbox" name="ordersettings-0-DELETE" id="id_ordersettings-0-DELETE">
</span>




    </span>



        </span>


</span>

    </div>

</div>

            <input id="id_brand_attributes-TOTAL_FORMS" name="brand_attributes-TOTAL_FORMS" type="hidden" value="0" /><input id="id_brand_attributes-INITIAL_FORMS" name="brand_attributes-INITIAL_FORMS" type="hidden" value="0" /><input id="id_brand_attributes-MAX_NUM_FORMS" name="brand_attributes-MAX_NUM_FORMS" type="hidden" value="1000" />





<div id="brand-attr-0" class="visuelProd new">
    <ul style="display:none;" class="ba_error errorlist"></ul>
    <input type="hidden" value="brand_attributes-__prefix__" name="ba_prefix">
    <span class="texture">
        <a class="uploadfile">
            <img class="ba_texture_btn" alt="Add a texture"/>
        </a>
        <input class="ba_texture_upload" style="display:none" type="file" name="texture_file">
    </span>
    <input class="ba_input title autocomplete" type="text" placeholder="Product variant" maxlength="50"/>

    <em>Please add pictures for this item below. Drag and drop pictures to arrange them in the desired order.</em>
    <input id="id_brand_attributes-__prefix__-previews-TOTAL_FORMS" name="brand_attributes-__prefix__-previews-TOTAL_FORMS" type="hidden" value="0" /><input id="id_brand_attributes-__prefix__-previews-INITIAL_FORMS" name="brand_attributes-__prefix__-previews-INITIAL_FORMS" type="hidden" value="0" /><input id="id_brand_attributes-__prefix__-previews-MAX_NUM_FORMS" name="brand_attributes-__prefix__-previews-MAX_NUM_FORMS" type="hidden" value="1000" />
    <div class="ba_previews listProd">
        <ul class="existing_pp horizontal_pp">
            <li class="ba_previews_upload">
                <a class="uploadfile">Click or drag a file here to add a picture</a>
                <input class="ba_preview_upload" style="display:none" type="file" name="files[]" multiple>
            </li>
        </ul>
        <ul class="pp_queue"></ul>
    </div>
    <div class="formrow">
        <label>Premium </label>
        <span class="brand_attributes-premium">
            <select id="id_brand_attributes-__prefix__-premium_type" name="brand_attributes-__prefix__-premium_type">
<option value="percentage">Pourcentage</option>
<option value="amount">Fixe</option>
</select>
            <input class="inputXS" id="id_brand_attributes-__prefix__-premium_amount" name="brand_attributes-__prefix__-premium_amount" type="text" />
            <span class="premium_ratio_marker" style="display:none">%</span>
            <span class="premium_currency_marker" style="display:none"></span>
        </span>
    </div>
    <div class="formrow marge">
        <label>Premium price </label>
        <span class="brand_attributes-premium-result">
        </span>
    </div>


    <div class="formrow marge accordion">
        <label>Code barre</label>
        <span class="contForm taille barcodes-block">


        <span class="barcodes-ba" data-ba="NEW">




    <span class="barcodes-item" data-ca="">


            <label for="id_barcodes-__prefix__-upc"></label>
<input id="id_barcodes-__prefix__-upc" type="text"  name="barcodes-__prefix__-upc" maxlength="50" value="">
<span style="display: none;">
    <input id="id_barcodes-__prefix__-common_attribute" name="barcodes-__prefix__-common_attribute" type="text" />
    <input id="id_barcodes-__prefix__-brand_attribute" name="barcodes-__prefix__-brand_attribute" type="text" value="NEW" />
    <input type="checkbox" name="barcodes-__prefix__-DELETE" id="id_barcodes-__prefix__-DELETE">
</span>



    </span>



        </span>


</span>

    </div>
    <div class="formrow marge accordion">
        <label>External Refs</label>
        <span class="contForm taille extrefs-block">


        <span class="extrefs-ba" data-ba="NEW">




    <span class="extrefs-item" data-ca="">


            <label for="id_externalrefs-__prefix__-external_id"></label>
<input id="id_externalrefs-__prefix__-external_id" type="text"  name="externalrefs-__prefix__-external_id" maxlength="50" value="">
<span style="display: none;">
    <input id="id_externalrefs-__prefix__-common_attribute" name="externalrefs-__prefix__-common_attribute" type="text" />
    <input id="id_externalrefs-__prefix__-brand_attribute" name="externalrefs-__prefix__-brand_attribute" type="text" value="NEW" />
    <input type="checkbox" name="externalrefs-__prefix__-DELETE" id="id_externalrefs-__prefix__-DELETE">
</span>



    </span>



        </span>


</span>

    </div>
    <div class="formrow marge accordion">
        <label>Order Require Confirmation</label>
        <span class="contForm taille ordersettings-block">


        <span class="ordersettings-ba" data-ba="NEW">




    <span class="ordersettings-item" data-ca="">


            <label for="id_ordersettings-__prefix__-require_confirm"></label>
<input id="id_ordersettings-__prefix__-require_confirm" name="ordersettings-__prefix__-require_confirm" type="checkbox" />
<span style="display: none;">
    <input id="id_ordersettings-__prefix__-common_attribute" name="ordersettings-__prefix__-common_attribute" type="text" />
    <input id="id_ordersettings-__prefix__-brand_attribute" name="ordersettings-__prefix__-brand_attribute" type="text" value="NEW" />
    <input type="checkbox" name="ordersettings-__prefix__-DELETE" id="id_ordersettings-__prefix__-DELETE">
</span>



    </span>



        </span>


</span>

    </div>


    <input class="btn valider add_ba" type="button" value="Ajouter"/>


<span id="ba_preview_template_form" style="display: none;">
    <li id="brand_attributes-__prefix__-previews-__prefix__-row" class="ba_preview_form">
        <input id="id_brand_attributes-__prefix__-previews-__prefix__-pk" name="brand_attributes-__prefix__-previews-__prefix__-pk" type="hidden" />
        <input id="id_brand_attributes-__prefix__-previews-__prefix__-url" name="brand_attributes-__prefix__-previews-__prefix__-url" type="hidden" />
        <input id="id_brand_attributes-__prefix__-previews-__prefix__-sort_order" name="brand_attributes-__prefix__-previews-__prefix__-sort_order" type="hidden" />
        <input style="display: none;" type="checkbox" name="brand_attributes-__prefix__-previews-__prefix__-DELETE" id="id_brand_attributes-__prefix__-previews-__prefix__-DELETE">
        <span>
            <span class="delete">Supprimer</span>
            <img id="brand_attributes-__prefix__-previews-__prefix__-img"/>
        </span>
    </li>
</span>

</div>



<div id="gallery" class="visuelProd">
    <strong class="title">Pictures Gallery</strong>
    <em>Drag and drop pictures to arrange them in the desired order.</em>
    <table></table>
</div>


        </div>
        <!--//VISUELS PRODUITS-->

    </fieldset>


        <button class="navForm" id="btn_cancel" name="wizard_cancel" value="product">Annuler</button>


        <input class="btn select" type="submit" value="Next: Shipping"/>


    </form>


    <span id="type_attribute_price_template_form" style="display: none;">

        <span id="type_attribute_prices-__prefix__-row" class="type_attribute_price_form">
            <input id="id_type_attribute_prices-__prefix__-tap_id" name="type_attribute_prices-__prefix__-tap_id" type="hidden" />
            <input id="id_type_attribute_prices-__prefix__-type_attribute" name="type_attribute_prices-__prefix__-type_attribute" type="hidden" />
            <input id="id_type_attribute_prices-__prefix__-type_attribute_price" name="type_attribute_prices-__prefix__-type_attribute_price" type="hidden" />
            <input style="display: none;" type="checkbox" name="type_attribute_prices-__prefix__-DELETE" id="id_type_attribute_prices-__prefix__-DELETE">
            <span id="type_attribute_prices-__prefix__-type_attribute" class="type_attribute_value"></span>
            <span id="type_attribute_prices-__prefix__-type_attribute_name" class="type_attribute_name"></span>
            <span id="type_attribute_prices-__prefix__-type_attribute_price" class="type_attribute_price"></span>
            <span id="type_attribute_prices-__prefix__-type_attribute_price_cur" class="type_attribute_price_currency"></span>
            <span class="remove_type_attribute_price">Supprimer</span>
        </span>

    </span>
    <span id="normal_price_template_form" style="display: none;">
        <span class="normal_price_name">Prix</span>
        <span class="normal_price_price"></span>
        <span class="normal_price_currency"></span>
        <span class="remove_normal_price">Supprimer</span>
    </span>
    <span id="type_attribute_weight_template_form" style="display: none;">

            <span id="type_attribute_weights-__prefix__-row" class="type_attribute_weight_form">
            <input id="id_type_attribute_weights-__prefix__-taw_id" name="type_attribute_weights-__prefix__-taw_id" type="hidden" />
            <input id="id_type_attribute_weights-__prefix__-type_attribute" name="type_attribute_weights-__prefix__-type_attribute" type="hidden" />
            <input id="id_type_attribute_weights-__prefix__-type_attribute_weight" name="type_attribute_weights-__prefix__-type_attribute_weight" type="hidden" />
            <input style="display: none;" type="checkbox" name="type_attribute_weights-__prefix__-DELETE" id="id_type_attribute_weights-__prefix__-DELETE">
            <span id="type_attribute_weights-__prefix__-type_attribute" class="type_attribute_value"></span>
            <span id="type_attribute_weights-__prefix__-type_attribute_name" class="type_attribute_name"></span>
            <span id="type_attribute_weights-__prefix__-type_attribute_weight" class="type_attribute_weight"></span>
            <span id="type_attribute_weights-__prefix__-type_attribute_weight_unit" class="type_attribute_weight_unit"></span>
            <span class="remove_type_attribute_weight">Supprimer</span>
        </span>

    </span>
    <span id="standard_weight_template_form" style="display: none;">
        <span class="standard_weight_name">Standard Weight</span>
        <span class="standard_weight"></span>
        <span class="standard_weight_unit"></span>
        <span class="remove_standard_weight">Supprimer</span>
    </span>
    <span id="product_picture_template_form" style="display: none;">
        <li id="product_pictures-__prefix__-row" class="product_picture_form">
            <input id="id_product_pictures-__prefix__-pk" name="product_pictures-__prefix__-pk" type="hidden" />
            <input id="id_product_pictures-__prefix__-thumb_url" name="product_pictures-__prefix__-thumb_url" type="hidden" />
            <input id="id_product_pictures-__prefix__-url" name="product_pictures-__prefix__-url" type="hidden" />
            <input id="id_product_pictures-__prefix__-sort_order" name="product_pictures-__prefix__-sort_order" type="hidden" />
            <input style="display: none;" type="checkbox" name="product_pictures-__prefix__-DELETE" id="">
            <span>
                <span class="delete">Supprimer</span>
                <img id="product_pictures-__prefix__-img"/>
            </span>
        </li>
    </span>
    <span id="varattr_template_form" style="display: none;">

        <div class="formrow">
            <label for="id_varattrs-__prefix__-value">None</label>
            <input id="id_varattrs-__prefix__-value" name="varattrs-__prefix__-value" type="text" />
            <span style="display:none;">
                <input id="id_varattrs-__prefix__-attr" name="varattrs-__prefix__-attr" type="text" />
                <input id="id_varattrs-__prefix__-name" name="varattrs-__prefix__-name" type="text" />
                <input id="id_varattrs-__prefix__-type" name="varattrs-__prefix__-type" type="text" />
                <input type="checkbox" name="varattrs-__prefix__-DELETE" id="id_varattrs-__prefix__-DELETE">
            </span>
        </div>

    </span>
    <div id="add_new_brand_dialog" style="display: none;">
        <form id="add_new_brand_form" action="/sales/brand/new/" method="post"><input type='hidden' name='csrfmiddlewaretoken' value='uthIeaJNPFphVpnXYzcP2VoA6EPTdhPH' />
            <p><label for="id_name">Name:</label> <input id="id_name" maxlength="50" name="name" type="text" /></p>
<p><label for="id_picture">Picture:</label> <input id="id_picture" name="picture" type="file" /></p>
            <input type="submit" value="Créer la Marque"/>
        </form>
    </div>


    <script type="text/javascript">
        $("#btn_first_step,#btn_prev_step").click(function(event){
            if(confirm("Les informations saisies sur cette page ne seront pas enregistrées. Voulez-vous continuer ?")==false)
                event.preventDefault();
        });
    </script>

    <div class="clear"></div>

            <!--FIN content-right-->
            <div class="clear"></div>
		</div>
		<!--FIN CONTENU-->

	</div>
	<!--FIN CONTENEUR-->

	<!--FOOTER-->
	<div id="footer">

            <!--<a href="http://www.backtoshops.com">www.backtoshops.com</a>-->
            <a href="/termsandconditions/"><strong>Terms & Conditions</strong></a>

	</div>
	<!--FIN FOOTER-->


<script type="text/javascript">
    jQuery(
        //JQuery的日历控件汉化
        function($){
            $.datepicker.regional['zh_CN'] = {
                clearText: '清除',

                clearStatus: '清除已选日期',
                closeText: '关闭',

                closeStatus: '不改变当前选择',
                prevText: '&lt;上月',

                prevStatus: '显示上月',
                nextText: '下月&gt;',

                nextStatus: '显示下月',
                currentText: '今天',

                currentStatus: '显示本月',
                monthNames: ['1月','2月','3月','4月','5月','6月',
                '7月','8月','9月','10月','11月','12月'],
                monthNamesShort: ['一','二','三','四','五','六',
                '七','八','九','十','十一','十二'],
                monthStatus: '选择月份', yearStatus: '选择年份',
                weekHeader: '周', weekStatus: '年内周次',
                dayNames: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],
                dayNamesShort: ['周日','周一','周二','周三','周四','周五','周六'],
                dayNamesMin: ['日','一','二','三','四','五','六'],
                dayStatus: '设置 DD 为一周起始',

                dateStatus: '选择 m月 d日, DD',
                dateFormat: 'yy-mm-dd',   //日期格式化形式

                firstDay: 7,
                initStatus: '请选择日期',

                showMonthAfterYear: true,
                yearSuffix: '年',

                isRTL: false
            };
            $.datepicker.setDefaults($.datepicker.regional[_get_datepicker_locale("fr-fr")]);
        }
    );

    $(document).ready(function(){

        currency_changed();
        prod_name_changed();
        set_default_option($('#id_product-brand'));
        set_default_category_option($('#id_product-category'));
        sort_existing_pp($('#existing_pp'));
        update_barcodes();
        update_extrefs();
        update_ordersettings();
        update_all_ba_premium();
    });

    function set_default_option(select_obj) {
        if (select_obj.find('option').length > 1
                && select_obj.find('option:selected').val() == ""
            || select_obj.find('option').length == 1
                && select_obj.find('option:selected').length == 0) {
            select_obj.find('option[value!=""]').selected().change();
        }
    }

    function set_default_category_option(select_obj) {
        if (select_obj.find('option').length == 1
                && select_obj.find('option:selected').length == 0) {
            select_obj.find('option:first').selected().change();
        }
    }

    /********************** Cover Picture ***********************/
    $("#upload-coverfile").fileupload({
        dataType: 'json',
        url: "/sales/picture/new/",
        dropZone: $('#upload-coverfile'),
        namespace: 'coverfile',
        formData: {is_cover: true},
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {

                _updateBackgroundImage($("#upload-coverfile .cover_btn"), "static/img/loading2.gif");
                $("#upload-coverfile .cover_btn").show();
                $("#upload-coverfile .cover_btn").siblings('div').hide();
                data.submit();
            }
        },
        done: function(e, data) {
            _updateBackgroundImage($("#upload-coverfile .cover_btn"), data.result.thumb_url);
            $("#id_product-cover_pk").val(data.result.pk);
            $("#id_product-cover_url").val(data.result.thumb_url);
        }
    });

    /********************** Product Picture ***********************/
    function addProductPicture(result) {
        var nb_of_forms = $("#id_product_pictures-TOTAL_FORMS").val();
        var form = $("#product_picture_template_form").html();
        form = form.replace(/__prefix__/g, nb_of_forms.toString()); // counting start from 0, so just use nb_of_forms here
        var picture_pk = "#id_product_pictures-__prefix__-pk".replace(/__prefix__/g, nb_of_forms.toString());
        var thumb_url = "#id_product_pictures-__prefix__-thumb_url".replace(/__prefix__/g, nb_of_forms.toString());
        var url = "#id_product_pictures-__prefix__-url".replace(/__prefix__/g, nb_of_forms.toString());
        var sort_order = "#id_product_pictures-__prefix__-sort_order".replace(/__prefix__/g, nb_of_forms.toString());
        var img = "#product_pictures-__prefix__-img".replace(/__prefix__/g, nb_of_forms.toString());
        $(form).insertBefore($("#existing_pp li.product_pictures_upload"));
        $("#existing_pp").sortable("refresh");
        $(picture_pk).val(result.pk);
        $(thumb_url).val(result.thumb_url);
        $(url).val(result.url);
        $(sort_order).val($("#existing_pp").find("li.product_picture_form").length);
        $(img).attr('src', result.thumb_url);

        nb_of_forms++;
        $("#id_product_pictures-TOTAL_FORMS").val(nb_of_forms);
    }

    var sale_img_upload_max_size = 1048576;
    var sale_img_upload_max_size_err = "File exceeds maximum allowed size of 1MB";
    function _validate_max_file_size(file) {
        if (file.size > sale_img_upload_max_size) {
            alert(sale_img_upload_max_size_err);
            return false;
        }
        return true;
    }
    $("#pp_upload").fileupload({
        dataType: 'json',
        url: "/sales/picture/new/",
        dropZone: $(".product_pictures_upload"),
        namespace: 'product_pictures',
        add: function(e, data) {
            if (_validate_max_file_size(data.files[0])) {
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    var to_append = '<li id="pp_'+id+'">'+file.name+' <b></b></li>';
                    $(this).find(".pp_queue").append(to_append);
                });
                data.submit();
            }
        },
        progress: function(e, data) {
            $.each(data.files, function(key, file) {
                var id = file.name.replace(/\W+/g, '-');
                var percentage = parseInt(data.loaded/data.total*100, 10);
                $("#pp_"+id+" b").html(percentage+"%");
            });
        },
        done: function(e, data) {
            if (data.result.status == 'ok') {
                addProductPicture(data.result);
            } else if (data.result.status == 'max_limit_error'){
                alert(sale_img_upload_max_size_err);
            } else {
                alert("Error happened when uploading, please try later, or contact system admin.");
            }
            $.each(data.files, function(key, file) {
                var id = file.name.replace(/\W+/g, '-');
                $("#pp_"+id).remove();
            });
        },
        fail: function(e, data) {
            alert("Error happened when uploading, please try later, or contact system admin.");
        }
    });

    $("#existing_pp").sortable({
        update: function(e, ui) {
            $(this).find("li.product_picture_form").each(function(idx){
                $(this).find("input[id^=id_product_pictures][id$=-sort_order]").val(idx);
            });
        },
        cancel: ".product_pictures_upload",
    });


    function _updateBackgroundImage(selector, url) {
        $(selector).attr('src', url);
    }

    /********************** Brand Attributes ***********************/
    function _updateData(obj, dic) {
        var data = obj.data("ba_data");
        if (data == undefined) {
            data = {};
        }
        for (i in dic) {
            if (i != undefined) {
                data[i] = dic[i];
            }
        }
        obj.data("ba_data", data);
    }

    function _getFromData(obj, key) {
        var data = obj.data("ba_data");
        if (data == undefined) { return -1; }
        if (data[key] == undefined) { return -1; }
        return data[key];
    }

    function _clearBaForm(obj) {
        obj.find('#ba_error').hide().empty();
        obj.find(".ba_input").val("");
        obj.find("select[id$=premium_type]").val("percentage");
        obj.find("input[id$=premium_amount]").val("");
        calcDiscount();
        obj.data("ba_data", {});
        obj.find("input[id$=-upc]").val('');
        obj.find("input[id$=-external_id]").val('');
        obj.find('.existing_pp li:last').siblings().remove();
        $("#id_brand_attributes-__prefix__-previews-TOTAL_FORMS").val(0);
        _updateBackgroundImage(obj.find(".ba_texture_btn"), '');
    }

    function _getBaFormCount() {
        return $("#id_brand_attributes-TOTAL_FORMS").val();
    }

    function _addBaFormCount() {
        var nb_of_forms = _getBaFormCount();
        nb_of_forms++;
        $("#id_brand_attributes-TOTAL_FORMS").val(nb_of_forms);
        return nb_of_forms
    }

    function addBaPreview(obj, result) {
        var prefix = obj.find("input[name=ba_prefix]").val();
        var nb_of_forms = obj.find("input[id^=id_" + prefix + "-previews-TOTAL_FORMS]").val();
        var form = obj.find("#ba_preview_template_form").html();
        var new_str = 'previews-' + nb_of_forms.toString();
        form = form.replace(/previews-__prefix__/g, new_str); // counting start from 0, so just use nb_of_forms here
        var picture_pk = "#id_brand_attributes-__prefix__-previews-__prefix__-pk".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        var url = "#id_brand_attributes-__prefix__-previews-__prefix__-url".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        var sort_order = "#id_brand_attributes-__prefix__-previews-__prefix__-sort_order".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        var img = "#brand_attributes-__prefix__-previews-__prefix__-img".replace(/brand_attributes-__prefix__/g, prefix).replace(/previews-__prefix__/g, new_str);
        $(form).insertBefore(obj.find(".existing_pp li.ba_previews_upload"));
        obj.find(".existing_pp").sortable("refresh");
        obj.find(picture_pk).val(result.pk);
        obj.find(sort_order).val(obj.find(".existing_pp li.ba_preview_form").length);
        obj.find(img).attr('src', result.thumb_url);

        nb_of_forms++;
        obj.find("input[id^=id_" + prefix + "-previews-TOTAL_FORMS]").val(nb_of_forms);
    }

    function ba_events(attr_obj) {
        var prefix = attr_obj.find("input[name=ba_prefix]").val();

        attr_obj.find('.ba_input').change(function(){
            var tab_id = $(this).parents('div .visuelProd').attr('id');
            $('.tabs li.brand-attr a[href=#' + tab_id + ']').text($(this).val());
        });
        attr_obj.find('.ba_input').change();

        attr_obj.find(".existing_pp").sortable({
            update: function(e, ui) {
                $(this).find("li.ba_preview_form").each(function(idx){
                    $(this).find("input[id^=id_" + prefix + "-previews-][id$=-sort_order]").val(idx);
                });
            },
            cancel: ".ba_previews_upload",
        });

        attr_obj.find(".ba_preview_upload").fileupload({
            dataType: 'json',
            url: "/sales/picture/new/",
            formData: {is_brand_attribute: true},
            dropZone: attr_obj.find('.ba_previews_upload'),
            namespace: 'ba_preview',
            add: function(e, data) {
                if (_validate_max_file_size(data.files[0])) {
                    $.each(data.files, function(key, file) {
                        var id = file.name.replace(/\W+/g, '-');
                        var to_append = '<li id="pp_'+id+'">'+file.name+' <b></b></li>';
                        attr_obj.find(".pp_queue").append(to_append);
                    });
                    data.submit();
                }
            },
            progress: function(e, data) {
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    var percentage = parseInt(data.loaded/data.total*100, 10);
                    $("#pp_"+id+" b").html(percentage+"%");
                });
            },
            done: function(e, data) {
                if (data.result.status == 'ok') {
                    addBaPreview(attr_obj, data.result);
                } else if (data.result.status == 'max_limit_error'){
                    alert(sale_img_upload_max_size_err);
                } else {
                    alert("Error happened when uploading, please try later, or contact system admin.");
                }
                $.each(data.files, function(key, file) {
                    var id = file.name.replace(/\W+/g, '-');
                    $("#pp_"+id).remove();
                });
                var previews_data = _getFromData(attr_obj, "previews");
                if (previews_data == -1)
                    previews_data = {};
                previews_data[data.result.pk] = {'sort_order': attr_obj.find(".existing_pp").find("li.ba_preview_form").length};
                _updateData(attr_obj, {previews: previews_data});
            },
            fail: function(e, data) {
                alert("Error happened when uploading, please try later, or contact system admin.");
            }
        });

        attr_obj.find(".ba_texture_upload").fileupload({
            dataType: 'json',
            url: "/attributes/brand_attributes/",
            dropZone: attr_obj.find('.texture'),
            namespace: 'ba_texture',
            formData: {pk: _getFromData(attr_obj, "texture_pk")},
            add: function(e, data) {
                if (_validate_max_file_size(data.files[0])) {
                    _updateBackgroundImage(attr_obj.find(".ba_texture_btn"), "static/img/loading2.gif");
                    data.submit();
                }
            },
            done: function(e, data) {
                _updateBackgroundImage(attr_obj.find(".ba_texture_btn"), data.result.texture);
                _updateData(attr_obj, {ba_pk: -1, texture_pk: data.result.pk, type_pk: 'new'});
                attr_obj.find("input[id*=texture]").val(data.result.texture);

            }
        });

        attr_obj.find(".ba_input.autocomplete").autocomplete({
            autoFocus: true,
            source: "/attributes/brand_attributes/",
            min_length: 2,
            html: true,
            showTyping: true,
            focus: function(event, ui) {
                $(this).val(ui.item.name);
                return false;
            },
            select: function(e, ui) {
                if ($('#brand-attr-' + ui.item.value).length > 0) {
                    if ($('#brand-attr-' + ui.item.value + ':not(.removed)').length > 0) {
                        alert('This product variant is already added.');
                        e.preventDefault();
                        return false;
                    } else {
                        alert('This product variant was removed, will be activated.');
                        e.preventDefault();
                        active_removed_tab('#brand-attr-' + ui.item.value);
                        add_barcode_for_brand_attr(ui.item.value);
                        add_extref_for_brand_attr(ui.item.value);
                        add_ordersetting_for_brand_attr(ui.item.value);
                        return false;
                    }
                }

                _updateData(attr_obj,
                            {name: ui.item.name,
                             ba_pk: ui.item.value,
                             premium_type: ui.item.premium_type,
                             premium_amount: ui.item.premium_amount,
                             texture_pk: ui.item.value,
                             type_pk: 'exist'});
                $(this).val(ui.item.name);
                $(this).siblings("#premium_amount").val(ui.item.premium_amount);
                $(this).siblings("#premium_type").val(ui.item.premium_type);
                calcDiscount();
                $(this).focusout();
                _updateBackgroundImage(attr_obj.find(".ba_texture_btn"), ui.item.texture);
                return false;
            }
        });

        attr_obj.find('.add_ba').click(function(e) {
            var name = attr_obj.find(".ba_input").val();
            if (!name) {
                alert('Le nom de l’attribut ne peut pas être nul.');
                e.preventDefault();
                return false;
            }
            var previews = [];
            attr_obj.find(".existing_pp li.ba_preview_form").each(function(){
                var pk = $(this).find("[id$=-pk]").val();
                var val = $(this).find("[id$=-sort_order]").val();
                previews.push({pk: pk, sort_order: val});
            });
            _updateData(attr_obj,
                        {name: name,
                         premium_type: attr_obj.find('select[id$=premium_type]').val(),
                         premium_amount: attr_obj.find('input[id$=premium_amount]').val(),
                         ba_pk: -1,
                         previews: JSON.stringify(previews),
                         ba_index: _getBaFormCount(),
                        });
            var data_send = attr_obj.data("ba_data");
            if (data_send.ba_pk == -1 && data_send.texture_pk != undefined) {
                data_send.pk = data_send.texture_pk;
            } else if (data_send.ba_pk != undefined) {
                data_send.pk = data_send.ba_pk;
            } else {
                data_send.pk = -1;
            }

            $.post("/attributes/brand_attributes/",
                data_send,
                function(data) {
                    if (data.success) {
                        new_tab($('.tabs'), 'brand-attr-' + data.pk,
                                data.name, data.ba_html);
                        var new_attr_obj = $('#brand-attr-' + data.pk);
                        ba_events(new_attr_obj);
                        add_barcode_for_brand_attr(data.pk, data.name, new_attr_obj);
                        add_extref_for_brand_attr(data.pk, data.name, new_attr_obj);
                        add_ordersetting_for_brand_attr(data.pk, data.name, new_attr_obj);

                        var obj = $('.tabs-header li:last').insertBefore($("li.add-attr"));
                        obj.find('a').click();

                        _addBaFormCount();
                        _clearBaForm(attr_obj);
                    } else {
                        attr_obj.find('.ba_error').show().append("<li>" + data.err + "</li>");
                    }
                }
            );
        });

        attr_obj.find('select[id$=premium_type]').change(function(){
            var premium_type = $(this).val();
            if (premium_type == 'amount') {
                $(this).siblings(".premium_ratio_marker").hide();
                $(this).siblings(".premium_currency_marker").show();
            } else {
                $(this).siblings(".premium_ratio_marker").show();
                $(this).siblings(".premium_currency_marker").hide();
            }
            update_ba_premium($(this).parents('.brand_attributes-premium'));
        });
        attr_obj.find('select[id$=premium_type]').change();

        attr_obj.find('input[id$=premium_amount]').change(function(){
            update_ba_premium($(this).parents('.brand_attributes-premium'));
        });

    }
    $("div[id^=brand-attr-]").each(function(){
        var attr_obj = $(this);
        ba_events(attr_obj);
    });

    function render_premium_result(premium_price_node, premium_type, premium_amount){
        var selected_cur = $("#id_product-currency option:selected").text();
        var normal_price = parseFloat($("#id_product-normal_price").val());
        premium_amount = parseFloat(premium_amount);
        premium_price_node.html('');
        if (normal_price) {
            $("<span>").html(_calc_premium_price(premium_type, premium_amount, normal_price))
                    .appendTo(premium_price_node);
            $("<span>").addClass("premium_currency_marker")
                    .html(selected_cur)
                    .appendTo(premium_price_node);
        } else {
            $("<span>").html('--').appendTo(premium_price_node);
        }
    };

    $(".remove_brand_attribute").live('click', function(){
        var ba = $(this).parents(".brand_attribute_form:first");
        ba.hide();
        var delete_input_id = "#id_"+ ba.attr('id').replace('-row', '-DELETE');
        $(delete_input_id).attr('checked', 'checked');
        return false;
    });


    /********************** Add New Brand ***********************/
    $("#add_new_brand_form").ajaxForm({
        //target: $("#id_product-brand"),
        success: function(responseText) {
            if(responseText.substring(0,5)=="ERROR")
            {
                $("#brand_new_error").html(responseText)
                $("#brand_new_error").show();
            }
            else
            {
                $("#id_product-brand").html(responseText)
                $("#brand_new_error").hide();
            }
            $("#add_new_brand_dialog").dialog("close");

        }
    });

    $("#add_new_brand").click(function(){
        $("#add_new_brand_dialog").dialog({
            modal: true,
            title: "Ajouter une marque",
            buttons: {
                "Cancel": function() {
                    $(this).dialog("close");
                }
            }
        });
        return false;
    });


    /********************** Discount ***********************/
    function _is_use_item_type_price() {
        return ($("span.normal_price_form:visible").length < 1 &&
                    $("span.type_attribute_price_form:visible").length > 0);
    }

    function _get_lowest_type_attribute_price() {
        var ta_prices = new Array();
        $("span.type_attribute_price_form:visible").each(function(){
            ta_prices.push(parseFloat($(this).find(".type_attribute_price").text()));
        });
        return ta_prices.length > 1 ? Math.min.apply(Math, ta_prices) : Math.min(ta_prices);
    }
    function _calc_discount_price(discount_type, discount, base_price) {
        if (discount_type == "percentage") { //percentage
            var tmp = base_price - (base_price * (discount / 100))
            return Math.round(tmp*100 +((tmp*1000%10>4)?1:0))/100;
        } else {
            return base_price - discount;
        }
    }
    function _calc_premium_price(premium_type, premium_amount, price) {
        if (premium_amount) {
            if (premium_type == "percentage") { //percentage
                var tmp = price + (price * (premium_amount / 100))
                return Math.round(tmp*100 +((tmp*1000%10>4)?1:0))/100;
            } else {
                return price + premium_amount;
            }
        } else {
            return price;
        }
    }
    function calcDiscount() {
        var use_item_type_price = _is_use_item_type_price();

        var discount = parseFloat($("#id_product-discount").val());
        if (isNaN(discount)) discount = 0;
        var discount_type = $("#id_product-discount_type").val();

        var discount_price_str_input = $("#id_product-preview_discount_price_str");
        var base_price_input = $("#id_product-preview_base_price");
        var discount_preview = $("#preview-id_product-preview_discount_price_str");
        var base_price_preview = $("#preview-id_product-preview_base_price");

        var selected_cur = $("#id_product-currency option:selected").text();
        $("#discount_marker").html(discount_type == "percentage" ? "%": selected_cur);

        var premium_type = $("#premium_type").val();
        $("#premium_marker").html(premium_type == "percentage" ? "%": selected_cur);

        if (use_item_type_price) {
            var lowest_type_attribute_price = _get_lowest_type_attribute_price();
            var start_price = _calc_discount_price(discount_type, discount, lowest_type_attribute_price);

            // disable discount and premiums preview if there is no Unified price.
            $("span#result").hide();
            $("span#premium_result").hide();

            // preview start price on the right-preview.
            var display_discount_price = "Starting at "
                    + (start_price > 0 ? start_price : lowest_type_attribute_price);
            base_price_input.val(lowest_type_attribute_price);
            base_price_preview.html(lowest_type_attribute_price + selected_cur);
            discount_price_str_input.val(display_discount_price);
            discount_preview.html(display_discount_price + selected_cur);
        } else {
            var normal_price = parseFloat($("#id_product-normal_price").val());
            var new_price = _calc_discount_price(discount_type, discount, normal_price);
            var premium_amount = parseFloat($("#premium_amount").val());
            var premium_price = _calc_premium_price(premium_type, premium_amount, new_price);

            $("span#result").show();
            $("span#premium_result").show();

            var display_price = new_price > 0 ? new_price : normal_price;
            if (isNaN(normal_price)) normal_price = "N/D";
            if (isNaN(display_price)) display_price = "N/D";
            $("#discount_price").html(display_price);
            base_price_input.val(normal_price);
            base_price_preview.html(normal_price + "&nbsp;" + selected_cur);
            discount_price_str_input.val(display_price);
            discount_preview.html(display_price + "&nbsp;" + selected_cur);

            if (premium_price > 0) {
                $("#premium_price_val").val(parseFloat(premium_price));
                $("#premium_price").html(parseFloat(premium_price));
            } else {
                if (new_price > 0) {
                    $("#premium_price_val").val(parseFloat(new_price));
                    $("#premium_price").html(new_price);
                }
                else {
                    $("#premium_price_val").val("");
                    $("#premium_price").html("N/D");
                }
            }
        }
    }

    $("#id_product-discount_type").change(function(){
        calcDiscount();
    });
    $("#id_product-normal_price").change(function(elmt){
        calcDiscount();
    });
    $("#id_product-discount").change(function(elmt){
        calcDiscount();
    });
    $("#premium_type").change(function(){
        calcDiscount();
    });
    $("#premium_amount").change(function(){
        calcDiscount();
    });


    /********************** Update Product Preveiw ***********************/
    function update_ba_premium(obj) {
        var premium_type = obj.find("select[id$=premium_type]").val();
        var premium_amount = obj.find("input[id$=premium_amount]").val() || 0;
        var result_node = obj.parent().next().find('.brand_attributes-premium-result');
        render_premium_result(result_node, premium_type, premium_amount);
    }
    function update_all_ba_premium() {
        $('.brand_attributes-premium').each(function (){
            update_ba_premium($(this));
        });
    }

    /********************** Type Attribute Price ***********************/
    $("#add_tap").click(function(e) {
        // blank price
        var ta_price = $("#type_attribute_price_input").val();
        if (!ta_price) {
            alert("The price can not be left blank.");
            e.preventDefault();
            return false;
        }

        var select_ta = $("#type_attribute_selector").val();
        var select_ta_name = $("#type_attribute_selector option:selected").text();
        var select_cur = $("#id_product-currency option:selected").text();


        // NORMAL PRICE
        if (select_ta == 0) {
            // Normal price has been added.
            if ($("#type_attribute_prices span.normal_price_price").length > 0) {
                alert("The Unified price has been added!");
                return false;
            }

            // Add normal price, fill input values and display
            $("<span>").addClass("normal_price_form")
                       .append($("#normal_price_template_form").html())
                       .appendTo($("#type_attribute_prices"));
            $("#id_product-normal_price").val(ta_price).change();
            $("#type_attribute_prices span.normal_price_price").text(ta_price);
            $("#type_attribute_prices span.normal_price_currency").text(select_cur);
            update_all_ba_premium();

            add_barcode_for_common_attr("", $("#id_product-name").val());
            add_extref_for_common_attr("", $("#id_product-name").val());
            add_ordersetting_for_common_attr("", $("#id_product-name").val());
            return false;
        }


        // TYPE ATTRIBUTE PRICE

        // this type attribute price has been added.
        if ($("#type_attribute_prices span.type_attribute_price_form:visible span.type_attribute_value[data-value="+select_ta+"]").length > 0) {
            alert("The price of \"" + select_ta_name + "\" has been added!");
            return false;
        }
        // add type attribute price
        var nb_of_forms = $("#id_type_attribute_prices-TOTAL_FORMS").val();
        var nb_of_forms_str = nb_of_forms.toString();
        var form = $("#type_attribute_price_template_form").html();
        form = replace_form_prefix(form, nb_of_forms_str);

        var tap_id_input = replace_form_prefix("#id_type_attribute_prices-__prefix__-tap_id", nb_of_forms_str);
        var type_attribute_input = replace_form_prefix("#id_type_attribute_prices-__prefix__-type_attribute", nb_of_forms_str);
        var type_attribute_price_input = replace_form_prefix("#id_type_attribute_prices-__prefix__-type_attribute_price", nb_of_forms_str);
        var ta_span = replace_form_prefix("#type_attribute_prices-__prefix__-type_attribute", nb_of_forms_str);
        var ta_name_span = replace_form_prefix("#type_attribute_prices-__prefix__-type_attribute_name", nb_of_forms_str);
        var tap_span = replace_form_prefix("#type_attribute_prices-__prefix__-type_attribute_price", nb_of_forms_str);
        var tapc_span = replace_form_prefix("#type_attribute_prices-__prefix__-type_attribute_price_cur", nb_of_forms);


        $("#type_attribute_prices").append(form);
        $(tap_id_input).val(-1);
        $(type_attribute_input).val(select_ta);
        $(type_attribute_price_input).val(ta_price);
        $(ta_span).text(select_ta);
        $(ta_span).attr("data-value", select_ta);
        $(ta_name_span).text(select_ta_name);
        $(tap_span).text(ta_price);
        $(tapc_span).text(select_cur);

        nb_of_forms++;
        $("#id_type_attribute_prices-TOTAL_FORMS").val(nb_of_forms);

        // Remove normal price option and input
        $("#type_attribute_selector option[value=0]").remove();
        $("span.normal_price_form").remove();
        $("#id_product-normal_price").val("").change();
        update_all_ba_premium();

        add_barcode_for_common_attr(select_ta, select_ta_name);
        add_extref_for_common_attr(select_ta, select_ta_name);
        add_ordersetting_for_common_attr(select_ta, select_ta_name);
        return false;
    });

    $("span.remove_type_attribute_price").live("click", function(){
        $(this).siblings("input:checkbox[id*=DELETE]").prop("checked", true);
        $(this).parent().hide();
        // Reappear normal price option
        if ($("span.type_attribute_price_form:visible").length < 1 &&
                $("#type_attribute_selector option[value=0]").length < 1) {
            $("#type_attribute_selector").prepend($("<option>", {value: 0, text: "Unified price"}));
        }
        calcDiscount();
        var attr_id = $(this).siblings('.type_attribute_value').text();
        remove_barcode_for_common_attr(attr_id);
        remove_extref_for_common_attr(attr_id);
        remove_ordersetting_for_common_attr(attr_id);
    });
    $("span.remove_normal_price").live("click", function(){
        $("#id_product-normal_price").val("").change();
        $(this).parent().remove();
        remove_barcode_for_common_attr("");
        remove_extref_for_common_attr("");
        remove_ordersetting_for_common_attr("");
    });


    /********************** Type Attribute Weight ***********************/
    $("#add_taw").click(function(e) {
        // blank weight
        var ta_weight = $("#type_attribute_weight_input").val();
        if (!ta_weight) {
            alert("The weight can not be left blank.");
            e.preventDefault();
            return false;
        }

        var select_ta = $("#type_attribute_weight_selector").val();
        var select_ta_name = $("#type_attribute_weight_selector option:selected").text();
        var select_wu = $("#id_product-weight_unit option:selected").text();

        // Standard Weight
        if (select_ta == 0) {
            // Standard weight has been added.
            if ($("#type_attribute_weights span.standard_weight").length > 0) {
                alert("The Standard Weight has been added!");
                return false;
            }

            // Add standard weight, fill input values and display
            $("<span>").addClass("standard_weight_form")
                    .append($("#standard_weight_template_form").html())
                    .appendTo($("#type_attribute_weights"));
            $("#id_product-standard_weight").val(ta_weight).change();
            $("#type_attribute_weights span.standard_weight").text(ta_weight);
            $("#type_attribute_weights span.standard_weight_unit").text(select_wu);
            return false;
        }

        // TYPE ATTRIBUTE WEIGHT

            // this type attribute weight has been added.
            if ($("#type_attribute_weights span.type_attribute_weight_form:visible span.type_attribute_value[data-value="+select_ta+"]").length > 0) {
                alert("The weight of \"" + select_ta_name + "\" has been added!");
                return false;
            }
            // add type attribute weight
            var nb_of_forms = $("#id_type_attribute_weights-TOTAL_FORMS").val();
            var nb_of_forms_str = nb_of_forms.toString();
            var form = $("#type_attribute_weight_template_form").html();
            form = replace_form_prefix(form, nb_of_forms_str);

            var taw_id_input = replace_form_prefix("#id_type_attribute_weights-__prefix__-taw_id", nb_of_forms_str);
            var type_attribute_input = replace_form_prefix("#id_type_attribute_weights-__prefix__-type_attribute", nb_of_forms_str);
            var type_attribute_weight_input = replace_form_prefix("#id_type_attribute_weights-__prefix__-type_attribute_weight", nb_of_forms_str);
            var ta_span = replace_form_prefix("#type_attribute_weights-__prefix__-type_attribute", nb_of_forms_str);
            var ta_name_span = replace_form_prefix("#type_attribute_weights-__prefix__-type_attribute_name", nb_of_forms_str);
            var taw_span = replace_form_prefix("#type_attribute_weights-__prefix__-type_attribute_weight", nb_of_forms_str);
            var tawu_span = replace_form_prefix("#type_attribute_weights-__prefix__-type_attribute_weight_unit", nb_of_forms);


        $("#type_attribute_weights").append(form);
        $(taw_id_input).val(-1);
        $(type_attribute_input).val(select_ta);
        $(type_attribute_weight_input).val(ta_weight);
        $(ta_span).attr("data-value", select_ta);
        $(ta_name_span).text(select_ta_name);
        $(taw_span).text(ta_weight);
        $(tawu_span).text(select_wu);

        nb_of_forms++;
        $("#id_type_attribute_weights-TOTAL_FORMS").val(nb_of_forms);

        // Remove standard weight option and input
        $("#type_attribute_weight_selector option[value=0]").remove();
        $("span.standard_weight_form").remove();
        $("#id_product-standard_weight").val("").change();

        return false;
    });

    $("span.remove_type_attribute_weight").live("click", function(){
        $(this).siblings("input:checkbox[id*=DELETE]").prop("checked", true);
        $(this).parent().hide();
        // Reappear standard weight option
        if ($("span.type_attribute_weight_form:visible").length < 1 &&
                $("#type_attribute_weight_selector option[value=0]").length < 1) {
            $("#type_attribute_weight_selector").prepend($("<option>", {value: 0, text: "Standard Weight"}));
        }
    });
    $("span.remove_standard_weight").live("click", function(){
        $("#id_product-standard_weight").val("").change();
        $(this).parent().remove();
    });


    function weight_unit_changed() {
        var selected_cur = $("#id_product-weight_unit option:selected").text();
        $("#taw_weight_unit").html(selected_cur);
        $("#type_attribute_weights span.standard_weight_unit").text(selected_cur);
        $(".type_attribute_weight_unit").each(function(){
            $(this).text(selected_cur);
        });
    }
    $("#id_product-weight_unit").change(function(e){
        weight_unit_changed();
    });

    /********************** Utils ***********************/
    String.prototype.replaceAll = function(reallyDo, replaceWith, ignoreCase) {
        if (!RegExp.prototype.isPrototypeOf(reallyDo)) {
            return this.replace(new RegExp(reallyDo, (ignoreCase ? "gi": "g")), replaceWith);
        } else {
            return this.replace(reallyDo, replaceWith);
        }
    }

    // Get product types by selected product category
    function getTypeOptions(cat_id) {
        if ($("#id_product-category option").length == 1 &&
            $("#id_product-category option")[0].textContent == 'Unspecified' ) {
            $("#id_product-category").parent().hide();
        }
        if (cat_id) {
            $(".helptext").hide();
        } else {
            cat_id = 0;
            $(".helptext").show();
        }
        $.ajax({
            type: "GET",
            url: "/sales/get_product_types/" + cat_id,
            dataType:"json",
            success: function(data, textStatus){
                $("#product_type_selector").empty();
                $.each(data, function(i, option){
                    if (option.valid) {
                        $("#product_type_selector").append($("<option>", {value: option.value, text: option.label}));
                    } else if ("None" != "None" && option.value == "None") {
                        $("#product_type_selector").append($("<option>", {value: option.value, text: "(invalid)" + option.label}));
                    }
                });
                if ("None" != "None") {
                    $("#product_type_selector").val("None").change();
                }
                set_default_option($('#product_type_selector'));

                if ($("#product_type_selector").length == 1 &&
                    $("#product_type_selector")[0].textContent == 'Unspecified') {
                    $("#product_type_selector").parent().hide();
                } else {
                    $("#product_type_selector").parent().show();
                }
            }
        });
        $("#product_type_selector").change();
    }

    // Get item type attributes by selected product type
    function getItemTypeAttributeOptions(type_id) {
        $("#id_product-type").val(type_id);
        get_desc_attrs(type_id);

        if (type_id) {
            $.ajax({
                type: "GET",
                url: "/attributes/get_item_attrs/" + type_id,
                dataType:"json",
                success: function(data, textStatus){
                    // initialise Price selector
                    $("#type_attribute_selector").empty();
                    if ($("span.type_attribute_price_form:visible").length < 1 &&
                            $("#type_attribute_selector option[value=0]").length < 1) {
                        $("#type_attribute_selector").prepend($("<option>", {value: 0, text: "Unified price"}));
                    }
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#type_attribute_selector").append($("<option>", {value: option.value, text: option.label}));
                        }
                        add_barcode_for_common_attr(option.value, option.label);
                        add_extref_for_common_attr(option.value, option.label);
                        add_ordersetting_for_common_attr(option.value, option.label);
                    });

                    // initialise weight selector
                    $("#type_attribute_weight_selector").empty();
                    if ($("span.type_attribute_weight_form:visible").length < 1 &&
                            $("#type_attribute_weight_selector option[value=0]").length < 1) {
                        $("#type_attribute_weight_selector").prepend($("<option>", {value: 0, text: "Standard Weight"}));
                    }
                    $.each(data, function(i, option){
                        if (option.valid) {
                            $("#type_attribute_weight_selector").append($("<option>", {value: option.value, text: option.label}));
                        }
                    });

                }
            });
        } else {
            $("#type_attribute_selector").empty();
            $("#type_attribute_selector").append($("<option>", {value: 0, text: "Unified price"}));
            $("#type_attribute_weight_selector").empty();
            $("#type_attribute_weight_selector").append($("<option>", {value: 0, text: "Standard Weight"}));
        }
    }

    function get_desc_attrs(type_id) {
        if (type_id) {
            clear_varattrs();
            if ($("#varattrs .formrow[data-type=" + type_id + "]").length > 0) {
                var rows = $("#varattrs .formrow[data-type=" + type_id + "]");
                rows.show();
                rows.find("input:checkbox[id*=DELETE]").removeAttr("checked");
                return;
            }

            $.ajax({
                type: "GET",
                url: "/attributes/get_var_item_attrs/" + type_id,
                dataType: "json",
                success: function(data, textStatus){
                    var nb_of_forms = $("#id_varattrs-TOTAL_FORMS").val();
                    $.each(data, function(i, option){
                        if (!option.valid) return;
                        var nb_of_forms_str = nb_of_forms.toString();
                        var form = $("#varattr_template_form").html();
                        form = replace_form_prefix(form, nb_of_forms_str);
                        $("#varattrs").append(form);

                        var type = replace_form_prefix("id_varattrs-__prefix__-type", nb_of_forms);
                        var attr = replace_form_prefix("id_varattrs-__prefix__-attr", nb_of_forms);
                        var name = replace_form_prefix("id_varattrs-__prefix__-name", nb_of_forms);
                        var value = replace_form_prefix("id_varattrs-__prefix__-value", nb_of_forms);
                        $("#varattrs .formrow").last().attr('data-type', type_id);
                        $("#" + type).val(type_id);
                        $("#" + attr).val(option.value);
                        $("#" + name).val(option.label);
                        $("label[for=" + value + "]").text(option.label);
                        nb_of_forms++;
                    });
                    $("#id_varattrs-TOTAL_FORMS").val(nb_of_forms);
                }
            });
        } else {
            clear_varattrs();
        }
    }
    function clear_varattrs() {
        $("#varattrs .formrow").hide();
        $("#varattrs input:checkbox[id*=DELETE]").attr("checked", "checked");
    }

    function _get_datepicker_locale(s) {
        var l = s.split('-');
        if (l[0] == 'en') return '';
        if (l[1]) l[1] = l[1].toUpperCase();
        l = l.join('_');
        return l;
    }

    function prod_name_changed() {
        var prod_name = $("#id_product-name").val();
        if (prod_name == '') {
            $('.tabs li.base-item a').text('Nom du produit');
        } else {
            $('.tabs li.base-item a').text(prod_name);
        }
        $('#base-item .title').text(prod_name);
    }
    $("#id_product-name").change(function(e){
        prod_name_changed();
    });


    function currency_changed() {
        var selected_cur = $("#id_product-currency option:selected").text();
        $("#id_discount_price_marker").html(selected_cur);
        $("#id_premium_price_marker").html(selected_cur);
        $("#tap_currency").html(selected_cur);
        $("#type_attribute_prices span.normal_price_currency").text(selected_cur);
        $(".type_attribute_price_currency").each(function(){
            $(this).text(selected_cur);
        });
        $(".premium_currency_marker").each(function(){
            $(this).text(selected_cur);
        });
        calcDiscount();
    }
    $("#id_product-currency").change(function(e){
        currency_changed();
    });

    function replace_form_prefix(str1, str2) {
        return str1.replace(/__prefix__/g, str2);
    }

    // Those will be called when page is reloaded, for example if data validation
    // fails or we clicked "prev" from next step
    calcDiscount();
    $("#id_product-brand").change();
    if ("None") {
        $("#id_product-category").change();
    }
    $("#id_product-valid_from").datepicker();
    $("#id_product-valid_to").datepicker({
        onSelect: function(dateText, inst) {
            $("#preview-id_product-valid_to").html(dateText).parents("span:first").show();
        }
    });
    $("#id_product-available_from").datepicker();
    $("#id_product-available_to").datepicker({
        onSelect: function(dateText, inst) {
            $("#preview-id_product-available_to").html(dateText).parents("span:first").show();
        }
    });

    /********************** Gallery ***********************/
    function render_gallery_row(name, imgs) {
        var index = $('#gallery table tr').length + 1;
        var _html = '<th>' + index + '</th>' +
                    '<td><div><h1></h1><ul></ul></div></td>';
        var row = $('<tr>').html(_html);
        row.find('h1').text(name);
        for (var idx in imgs) {
            row.find('ul').append($('<li><img orig_id="' + imgs[idx]['id']  + '" src="' + imgs[idx]['src'] + '"/></li>'));
        }
        return row
    }
    function render_gallery() {
        var table = $('#gallery table');
        table.html('');

        var prod_name = $("#id_product-name").val() || '';
        var prod_imgs = [];
        $("#existing_pp img").each(function(){
            var del_node = $(this).parent().siblings('input:checkbox[id*=DELETE]')
            if (del_node.attr("checked") != 'checked') {
                var _id = $(this).attr('id');
                var _src = $(this).attr('src');
                prod_imgs.push({id: _id, src: _src})
            }
        });
        $(render_gallery_row(prod_name, prod_imgs)).appendTo(table);

        $("li.brand-attr:visible").each(function(){
            var tab_id = $(this).find('a').attr('href');
            var attr_name = $(this).find('a').text();
            var attr_imgs = [];
            $(tab_id + " .existing_pp img").each(function(){
                var del_node = $(this).parent().siblings('input:checkbox[id*=DELETE]')
                if (del_node.attr("checked") != 'checked') {
                    var _id = $(this).attr('id');
                    var _src = $(this).attr('src');
                    attr_imgs.push({id: _id, src: _src})
                }
            });
            $(render_gallery_row(attr_name, attr_imgs)).appendTo(table);
        });

        table.find('ul').each(function(){
            $(this).sortable();
        });
    }
    function save_gallery() {
        var table = $('#gallery table');
        table.find('ul').each(function(){
            $(this).find('img').each(function(img_idx){
                var img_row_id = $(this).attr('orig_id').replace('-img', '-row');
                $('#' + img_row_id).find('[id$=-sort_order]').val(img_idx);
            });
        });
    }
    function sort_existing_pp(ul_obj) {
        var li_objs = ul_obj.find('li');
        var i = 0;
        for (i=0; i< li_objs.length; i++) {
            var li = li_objs.find('[id$=-sort_order][value=' + i + ']').parents('li');
            ul_obj.append(li);
            li.insertBefore(li_objs.last());
        }
    }

    /********************** Tabs ***********************/
    function new_tab(tabs, tabId, tabLabel, tabContentHtml) {
         var header = "<li class='brand-attr'><span class='delete'>Delete</span><a href='#" + tabId + "'>" + tabLabel + "</a> </li>";
         tabs.find(".ui-tabs-nav").append(header);
         tabs.append("<div id='" + tabId + "' class='visuelProd'>" + tabContentHtml + "</div>");
         tabs.tabs("refresh");
    }

    $(".tabs").on('tabsactivate', function(event, ui) {
        var index = ui.newTab.index();
        if (index === $('.tabs >ul >li').length - 1) {
            // last tab
            render_gallery();
        } else {
            save_gallery();
            if (index == 0) {
                sort_existing_pp($('#existing_pp'));
            } else {
                var attr_id = ui.newTab.find('a').attr('href');
                if (attr_id != '#brand-attr-0')
                    sort_existing_pp($(attr_id + ' .existing_pp'));
            }
        }
    });

    $(document).on("click", "ul.tabs-header li.brand-attr .delete", function(){
        var tab_id = $(this).siblings('a').attr('href');
        $(this).parents('.brand-attr').hide();
        $(tab_id).addClass('removed').hide();
        $(tab_id).find("input:checkbox[id*=DELETE]:first").attr("checked", "checked");
        $('.tabs-header li.base-item a').click();

        remove_barcode_for_brand_attr(tab_id.replace('#brand-attr-', ''));
        remove_extref_for_brand_attr(tab_id.replace('#brand-attr-', ''));
        remove_ordersetting_for_brand_attr(tab_id.replace('#brand-attr-', ''));
    });

    function active_removed_tab(tab_id) {
        $(tab_id).removeClass('removed').show();
        $(tab_id).find("input:checkbox[id*=DELETE]:first").removeAttr("checked");
        $('.brand-attr a[href="' + tab_id + '"]').parents('.brand-attr').show();
        $('.brand-attr a[href="' + tab_id + '"]').click();
    }

    /********************** Upload files ***********************/
    $(document).on("click", "a.uploadfile",function(){
        $(this).siblings('input[type=file]').click();
    });
    $(document).on("click", ".visuelProd ul li span .delete",function(){
        $(this).parents('li').hide();
        $(this).parents('li').find('input:checkbox[id*=DELETE]').attr("checked", "checked");
    });

    /********************** Barcode ***********************/
    function update_barcodes() {
        var ca_ids = _get_ca_ids();
        _update_barcode_display($('#base-item'), ca_ids);
        _update_barcode_display($('[id^=brand-attr-]'), ca_ids);
        _update_barcodes_delete();
    }
    function _get_ca_ids() {
        var ca_ids = [];
        if (_is_use_item_type_price()) {
            $('.type_attribute_price_form:visible .type_attribute_value').each(function() {
                ca_ids.push($(this).text());
            });
        } else {
            $('#type_attribute_selector option').each(function() {
                if ($(this).val() != "0")
                    ca_ids.push($(this).val());
            });
        }
        return ca_ids;
    }
    function _update_barcode_display(show_tabs, ca_ids) {
        show_tabs.find('.barcodes-item').each(function() {
            if (ca_ids.length > 0 && ca_ids.indexOf($(this).attr('data-ca')) == -1)
                $(this).hide();
            else
                $(this).show();
        });
        show_tabs.find('.barcodes-block').show();
    }
    function _update_barcodes_delete() {
        $('.barcodes-block .barcodes-item').each(function(){
            var node = $(this);
            if (node.css('display') == 'none'
                    || node.parents('.barcodes-ba').css('display') == 'none'
                    || node.parents('.barcodes-block').css('display') == 'none')
                node.find("input:checkbox[id$=DELETE]").attr("checked", "checked");
            else
                node.find("input:checkbox[id$=DELETE]").removeAttr("checked");
        });
    }

    function add_barcode_for_brand_attr(attr_id, attr_name, attr_obj) {
        if ($('.barcodes-ba[data-ba="' + attr_id + '"]').length > 0) {
            $('.barcodes-ba[data-ba="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#id_barcodes-TOTAL_FORMS").val();
            $('#brand-attr-0 .barcodes-ba').each(function() {
                var newba = $(this).clone();
                newba.attr('data-ba', attr_id);
                newba.appendTo(attr_obj.find('.barcodes-block'));
                newba.show();

                newba.find('.barcodes-item').each(function() {
                    var node = $(this);
                    var old_prefix = node.find("input[name*=-upc]").attr('name').replace('-upc', '');
                    var new_prefix = 'barcodes-' + nb_of_forms;
                    var value = node.find("input[id$=-upc]").val();
                    node.html(node.html().replaceAll(old_prefix, new_prefix));
                    node.find("input[id$=-upc]").val(value);
                    node.find("input[id$=brand_attribute]").val(attr_id);
                    node.find("input[id$=brand_attribute]").attr('value', attr_id);

                    nb_of_forms++;
                    $("#id_barcodes-TOTAL_FORMS").val(nb_of_forms);
                });
            });
        }
        update_barcodes();
    }
    function remove_barcode_for_brand_attr(attr_id) {
        $('.barcodes-ba[data-ba="' + attr_id + '"]').hide();
        update_barcodes();
    }
    function add_barcode_for_common_attr(attr_id, attr_name) {
        if (attr_id && $('.barcodes-item[data-ca=""]').length > 0) {
            $('.barcodes-item[data-ca=""]').hide();
        }
        if ($('.barcodes-item[data-ca="' + attr_id + '"]').length > 0) {
            $('.barcodes-item[data-ca="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#id_barcodes-TOTAL_FORMS").val();
            $('.barcodes-ba').find('.barcodes-item:last').each(function() {
                var newnode = $(this).clone();
                var old_prefix = newnode.find("input[name*=-upc]").attr('name').replace('-upc', '');
                var new_prefix = 'barcodes-' + nb_of_forms;
                newnode.html(newnode.html().replaceAll(old_prefix, new_prefix));
                newnode.find('label').text(attr_name);
                newnode.find("input[id$=-upc]").val('');
                newnode.find("input[id$=common_attribute]").val(attr_id);
                newnode.find("input[id$=common_attribute]").attr('value', attr_id);
                newnode.insertAfter($(this));
                newnode.show();
                newnode.attr('data-ca', attr_id);

                nb_of_forms++;
                $("#id_barcodes-TOTAL_FORMS").val(nb_of_forms);
            });
        }
        update_barcodes();
    }
    function remove_barcode_for_common_attr(attr_id) {
        $('.barcodes-item[data-ca="' + attr_id + '"]').hide();
        update_barcodes();
    }

    /********************** External Ref ***********************/
    function update_extrefs() {
        var ca_ids = _get_ca_ids();
        _update_extrefs_display($('#base-item'), ca_ids)
        _update_extrefs_display($('[id^=brand-attr-]'), ca_ids)
        _update_extrefs_delete();
    }
    function _update_extrefs_display(show_tabs, ca_ids) {
        show_tabs.find('.extrefs-item').each(function() {
            if (ca_ids.length > 0 && ca_ids.indexOf($(this).attr('data-ca')) == -1)
                $(this).hide();
            else
                $(this).show();
        });
        show_tabs.find('.extrefs-block').show();
    }
    function _update_extrefs_delete() {
        $('.extrefs-block .extrefs-item').each(function(){
            var node = $(this);
            if (node.css('display') == 'none'
                    || node.parents('.extrefs-ba').css('display') == 'none'
                    || node.parents('.extrefs-block').css('display') == 'none')
                node.find("input:checkbox[id$=DELETE]").attr("checked", "checked");
            else
                node.find("input:checkbox[id$=DELETE]").removeAttr("checked");
        });
    }

    function add_extref_for_brand_attr(attr_id, attr_name, attr_obj) {
        if ($('.extrefs-ba[data-ba="' + attr_id + '"]').length > 0) {
            $('.extrefs-ba[data-ba="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#id_externalrefs-TOTAL_FORMS").val();
            $('#brand-attr-0 .extrefs-ba').each(function() {
                var newba = $(this).clone();
                newba.attr('data-ba', attr_id);
                newba.appendTo(attr_obj.find('.extrefs-block'));
                newba.show();

                newba.find('.extrefs-item').each(function() {
                    var node = $(this);
                    var old_prefix = node.find("input[name*=-external_id]").attr('name').replace('-external_id', '');
                    var new_prefix = 'extrefs-' + nb_of_forms;
                    var value = node.find("input[id$=-external_id]").val();
                    node.html(node.html().replaceAll(old_prefix, new_prefix));
                    node.find("input[id$=-external_id]").val(value);
                    node.find("input[id$=brand_attribute]").val(attr_id);
                    node.find("input[id$=brand_attribute]").attr('value', attr_id);

                    nb_of_forms++;
                    $("#id_externalrefs-TOTAL_FORMS").val(nb_of_forms);
                });
            });
        }
        update_extrefs();
    }
    function remove_extref_for_brand_attr(attr_id) {
        $('.extrefs-ba[data-ba="' + attr_id + '"]').hide();
        update_extrefs();
    }
    function add_extref_for_common_attr(attr_id, attr_name) {
        if (attr_id && $('.extrefs-item[data-ca=""]').length > 0) {
            $('.extrefs-item[data-ca=""]').hide();
            var nodes = $('.extrefs-item[data-ca=""]:hidden');
            nodes.find("input:checkbox[id*=DELETE]").attr("checked", "checked");
        }
        if ($('.extrefs-item[data-ca="' + attr_id + '"]').length > 0) {
            $('.extrefs-item[data-ca="' + attr_id + '"]').show();
            var nodes = $('.extrefs-item[data-ca="' + attr_id + '"]:visible');
            nodes.find("input:checkbox[id*=DELETE]").removeAttr("checked");
        } else {
            var nb_of_forms = $("#id_externalrefs-TOTAL_FORMS").val();
            $('.extrefs-ba').find('.extrefs-item:last').each(function() {
                var newnode = $(this).clone();
                var old_prefix = newnode.find("input[name*=-external_id]").attr('name').replace('-external_id', '');
                var new_prefix = 'extrefs-' + nb_of_forms;
                newnode.html(newnode.html().replaceAll(old_prefix, new_prefix));
                newnode.find('label').text(attr_name);
                newnode.find("input[id$=-external_id]").val('');
                newnode.find("input[id$=common_attribute]").val(attr_id);
                newnode.find("input[id$=common_attribute]").attr('value', attr_id);
                newnode.insertAfter($(this));
                newnode.show();
                newnode.attr('data-ca', attr_id);

                nb_of_forms++;
                $("#id_externalrefs-TOTAL_FORMS").val(nb_of_forms);
            });
        }
        update_extrefs();
    }
    function remove_extref_for_common_attr(attr_id) {
        $('.extrefs-item[data-ca="' + attr_id + '"]').hide();
        update_extrefs();
    }

    /********************** Order require confirmation ***********************/
    function update_ordersettings() {
        var ca_ids = _get_ca_ids();
        _update_ordersettings_display($('#base-item'), ca_ids)
        _update_ordersettings_display($('[id^=brand-attr-]'), ca_ids)
        _update_ordersettings_delete();
    }
    function _update_ordersettings_display(show_tabs, ca_ids) {
        show_tabs.find('.ordersettings-item').each(function() {
            if (ca_ids.length > 0 && ca_ids.indexOf($(this).attr('data-ca')) == -1)
                $(this).hide();
            else
                $(this).show();
        });
        show_tabs.find('.ordersettings-block').show();
    }
    function _update_ordersettings_delete() {
        $('.ordersettings-block .ordersettings-item').each(function(){
            var node = $(this);
            if (node.css('display') == 'none'
                    || node.parents('.ordersettings-ba').css('display') == 'none'
                    || node.parents('.ordersettings-block').css('display') == 'none')
                node.find("input:checkbox[id$=DELETE]").attr("checked", "checked");
            else
                node.find("input:checkbox[id$=DELETE]").removeAttr("checked");
        });
    }

    function add_ordersetting_for_brand_attr(attr_id, attr_name, attr_obj) {
        if ($('.ordersettings-ba[data-ba="' + attr_id + '"]').length > 0) {
            $('.ordersettings-ba[data-ba="' + attr_id + '"]').show();
        } else {
            var nb_of_forms = $("#id_ordersettings-TOTAL_FORMS").val();
            $('#brand-attr-0 .ordersettings-ba').each(function() {
                var newba = $(this).clone();
                newba.attr('data-ba', attr_id);
                newba.appendTo(attr_obj.find('.ordersettings-block'));
                newba.show();

                newba.find('.ordersettings-item').each(function() {
                    var node = $(this);
                    var old_prefix = node.find("input[name*=-require_confirm]").attr('name').replace('-require_confirm', '');
                    var new_prefix = 'ordersettings-' + nb_of_forms;
                    var value = node.find("input[id$=-require_confirm]").val();
                    node.html(node.html().replaceAll(old_prefix, new_prefix));
                    node.find("input[id$=-require_confirm]").val(value);
                    node.find("input[id$=brand_attribute]").val(attr_id);
                    node.find("input[id$=brand_attribute]").attr('value', attr_id);

                    nb_of_forms++;
                    $("#id_ordersettings-TOTAL_FORMS").val(nb_of_forms);
                });
            });
        }
        update_ordersettings();
    }
    function remove_ordersetting_for_brand_attr(attr_id) {
        $('.ordersettings-ba[data-ba="' + attr_id + '"]').hide();
        update_ordersettings();
    }
    function add_ordersetting_for_common_attr(attr_id, attr_name) {
        if (attr_id && $('.ordersettings-item[data-ca=""]').length > 0) {
            $('.ordersettings-item[data-ca=""]').hide();
            var nodes = $('.ordersettings-item[data-ca=""]:hidden');
            nodes.find("input:checkbox[id*=DELETE]").attr("checked", "checked");
        }
        if ($('.ordersettings-item[data-ca="' + attr_id + '"]').length > 0) {
            $('.ordersettings-item[data-ca="' + attr_id + '"]').show();
            var nodes = $('.ordersettings-item[data-ca="' + attr_id + '"]:visible');
            nodes.find("input:checkbox[id*=DELETE]").removeAttr("checked");
        } else {
            var nb_of_forms = $("#id_ordersettings-TOTAL_FORMS").val();
            $('.ordersettings-ba').find('.ordersettings-item:last').each(function() {
                var newnode = $(this).clone();
                var old_prefix = newnode.find("input[name*=-require_confirm]").attr('name').replace('-require_confirm', '');
                var new_prefix = 'ordersettings-' + nb_of_forms;
                newnode.html(newnode.html().replaceAll(old_prefix, new_prefix));
                newnode.find('label').text(attr_name);
                newnode.find("input[id$=-require_confirm]").val('');
                newnode.find("input[id$=common_attribute]").val(attr_id);
                newnode.find("input[id$=common_attribute]").attr('value', attr_id);
                newnode.insertAfter($(this));
                newnode.show();
                newnode.attr('data-ca', attr_id);

                nb_of_forms++;
                $("#id_ordersettings-TOTAL_FORMS").val(nb_of_forms);
            });
        }
        update_ordersettings();
    }
    function remove_ordersetting_for_common_attr(attr_id) {
        $('.ordersettings-item[data-ca="' + attr_id + '"]').hide();
        update_ordersettings();
    }

    function varattr_autocomplete(attr_obj, attr_id) {
        attr_obj.autocomplete({
            autoFocus: true,
            source: "/sales/get_item_varattr_values/" + attr_id,
            min_length: 0,
            html: true,
            showTyping: true
        });
    }
    $("#varattrs input[name$=-value]").live('focus', function(){
        var attr_id = $(this).parent().find("input[name$=-attr]").val();
        varattr_autocomplete($(this), attr_id);
    });
</script>

</body>
</html>

